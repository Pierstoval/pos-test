name: Main CI

on:
  push: ~
  pull_request: ~

jobs:
  build:
    name: Building ${{ matrix.target }} for ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        target: [release, development]
        os:
          - ubuntu-latest

    env:
      RUST_BACKTRACE: full
      PAGOO_LOG: trace
      RELEASE: ${{ (matrix.target == 'release' && '1') || '0' }}

    runs-on: ${{ matrix.os }}
    steps:
      - name: "Checkout the code"
        uses: actions/checkout@v4

      - name: ğŸ—„ï¸ Setup Rust cache
        uses: actions/cache@v4
        with:
          key: ${{ matrix.os }}-${{ hashFiles('Cargo.lock') }}
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git
            ./target

      - name: ğŸ¦€ Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ”Œ Download Rust dependencies
        run: cargo fetch

      - name: ğŸ—ï¸ ğŸ’½ Build application
        run: make build

      - name: ğŸ§ª Run all tests
        run: make test

      - name: ğŸ—ƒ Store Linux artifacts (release only)
        uses: actions/upload-artifact@v4
        if: startsWith(github.ref, 'refs/tags/v') && matrix.target == 'release'
        with:
          name: compotes_artifacts_${{ matrix.os }}
          overwrite: true
          path: |
            target/release/pagoo
